# JisuiArc2PDF.ps1

複数の画像書庫ファイルを、画像の並び順を維持したまま高品質なPDFに変換するPowerShellスクリプトです。
7-zipで解凍できる形式の書庫（RAR, ZIPなど）をサポートしており、本をスキャンしてアーカイブ形式でまとめた自炊書籍をPDFに変換することを想定しています。

## 概要

このスクリプトは、ワイルドカードパターン（例: `*.rar`）で指定された複数の書庫ファイルを個別に処理し、それぞれを一つのPDFファイルに変換します。アーカイブ内の画像ファイルを自然順（例: 1.jpg, 2.jpg, 10.jpg）に並べ替え、元のアーカイブと同じ名前のPDFを生成します。
7-zipで解凍できる形式の書庫（RAR, ZIPなど）をサポートしています。

## 主な機能

-   **ワイルドカードによる複数ファイルの指定**: `*.rar` のようなワイルドカードパターンを指定して、複数の書庫ファイルを一度に処理できます。
-   **堅牢なパス解決**: スクリプト内部でワイルドカードを展開するため、シェルの挙動に依存せず安定して動作します。
-   **多様な画像形式に対応**: ImageMagickが認識できるすべての画像形式をサポートします。
-   **画像ファイルの自動選別**: 書庫内のファイルをImageMagickで順に識別し、**画像として認識されたファイルのみを処理対象**とし、画像以外のファイル（テキストファイルなど）は**自動的に無視されます**。
-   **インテリジェントな画像変換**:
    -   画像の彩度を自動で判別し、カラー画像とグレースケール画像をそれぞれ最適に処理します。
    -   画像はPDF化に適したサイズと解像度にリサイズされます。デフォルトでは**A4サイズ・144dpi相当（高さ1683px）**に設定されており、細かくカスタマイズ可能です。
    -   **画質設定**: 生成されるJPEG画像の品質を調整できます。（デフォルト: 85）
-   **PDFの最適化**:
    -   `pdfcpu` を使用して、画像の結合、PDFの最適化、およびビューア設定の調整を自動で行います。
-   **ログ機能**: 変換が成功するたびに、使用した設定を `JisuiArc2PDF_log.txt` に自動で記録します。これにより、後からどのファイルがどの設定で変換されたかを確認できます。
-   **自然順ソート**: ファイル名に含まれる数字を数値として認識し、正しいページ順序でPDFを生成します。
-   **タイムスタンプの維持**: 生成されるPDFの作成日時と更新日時を、元のアーカイブファイルのものと一致させます。
-   **クリーンアップ**: 処理中に使用した一時ファイルは自動的に削除されます。

## 前提条件

### PowerShell バージョン
このスクリプトは `Start-Process` コマンドレットの `-RedirectStandardError` パラメータを使用しているため、**PowerShell 6.0 以上 (`pwsh.exe`)** が必要です。

-   **Windows:** [PowerShell 7](https://learn.microsoft.com/ja-jp/powershell/scripting/install/installing-powershell-on-windows) をインストールしてください。`pwsh.exe` でスクリプトを実行する必要があります。
-   **Linux / macOS:** PowerShell 6.0以上がインストールされていれば動作するかもしれません。

**動作確認について**
このスクリプトはクロスプラットフォームでの動作を意図して作られていますが、開発者による動作確認はWindows環境でのみ行われています。LinuxやmacOSでの動作は保証されていませんので、ご了承ください。

お使いのPowerShellのバージョンは、`pwsh -c "$PSVersionTable.PSVersion"` を実行することで確認できます。Windowsに標準搭載の `powershell.exe` (バージョン5.1) では動作しないためご注意ください。

### 必要なソフトウェア
このスクリプトを実行するには、以下のソフトウェアがインストールされている必要があります。

-   **ImageMagick**: 画像処理（リサイズ、品質調整、色空間変換）に使用します。
    -   `magick.exe` が必要です。
-   **7-Zip**: アーカイブファイルの展開に使用します。
    -   `7z.exe` と、それが動作するために必要な `7z.dll` が必要です。これらは通常、7-Zipをインストールしたフォルダに一緒に配置されています。
-   **PDFCPU**: 画像ファイルからPDFを生成・最適化するために使用します。
    -   `pdfcpu.exe` が必要です。

これらのソフトウェアは、以下のいずれかの方法で利用可能にしてください。
- **方法1 (推奨):** `JisuiArc2PDF.ps1` スクリプトファイルと同じフォルダに、`magick.exe`, `7z.exe`, `pdfcpu.exe` を配置してください。スクリプトはこれらのファイルを自動的に検出します。
- **方法2:** 各ソフトウェアをインストールし、その実行ファイルがシステムの環境変数PATHに登録されていることを確認してください。
    -   コマンドプロンプトやPowerShellで `magick -version`, `7z`, `pdfcpu version` を実行して、それぞれのバージョン情報が表示されれば、正しくPATHが通っています。（7zは引数なしで実行します）

## 設定

スクリプト実行時にオプションの引数を指定することで、画質や解像度を細かく制御できます。指定しない場合は、カッコ内のデフォルト値が使用されます。

### 解像度設定
変換される画像の縦方向の解像度（ピクセル数）を制御します。以下のいずれかの方法で指定できます。

-   `-Height <整数>` (エイリアス: `-h`)
    画像の高さをピクセル単位で直接指定します。

-   `-Dpi <整数>` (エイリアス: `-d`) および `-PaperSize <文字列>` (エイリアス: `-p`)
    画像のDPI（Dots Per Inch）と用紙サイズを指定します。`-Dpi` と `-PaperSize` は **同時に指定** する必要があります。
    -   `-PaperSize` で指定可能な値: `A3`, `A4`, `A5`, `B4`, `B5`, `B6`
    -   例: `.\JisuiArc2PDF.ps1 *.rar -p B5 -d 300`

**優先順位とデフォルトの挙動:**
1.  `-Height` が指定された場合、その値が最優先されます。
2.  `-Dpi` と `-PaperSize` が両方指定された場合、それらの値から高さが自動計算されます。
3.  何も指定されない場合、**A4サイズ・144dpi相当（高さ1683px）** がデフォルト値として使用されます。

**注意:**
- `-Dpi` または `-PaperSize` のみを指定した場合、エラーが発生します。両方を指定するか、またはどちらも指定しないでください。

**使用例:**
```powershell
# 高さを2000pxに直接指定
pwsh -File .\JisuiArc2PDF.ps1 *.rar -h 2000

# B5サイズ、300dpiで高さを自動計算
pwsh -File .\JisuiArc2PDF.ps1 *.rar -p B5 -d 300
```

### 画質と色判定の設定

-   `-Quality <整数>` (エイリアス: `-q`)
    PDFに変換される際の中間JPEG画像の品質を決定します。`1` から `100` の範囲で指定します。（デフォルト: `85`）
    -   値を大きくすると画質が向上しますが、ファイルサイズも増加します。
    -   値を小さくするとファイルサイズを削減できますが、画質は低下します。
    -   ImageMagickのJPEG品質設定の詳細については、[こちら](https://qiita.com/yoya/items/216d2fc98deb88fa7157)を参照してください。

-   `-SaturationThreshold <小数>` (エイリアス: `-s`, `-sat`)
    画像をグレースケールと判断する彩度のしきい値です。（デフォルト: `0.05`）

**使用例:**
```powershell
# 短いエイリアスを使い、品質を95に設定して実行
pwsh -File .\JisuiArc2PDF.ps1 "MyBook.rar" -q 95

# 品質と彩度しきい値の両方を指定
pwsh -File .\JisuiArc2PDF.ps1 "MyBook.rar" -Quality 92 -SaturationThreshold 0.03
```

#### `-SaturationThreshold` の詳細

このスクリプトは、画像1枚ごとの「平均彩度」を計算し、その値がここで設定したしきい値（Threshold）より低いかどうかで、カラー画像かグレースケール画像かを判断します。

-   **彩度とは？**
    -   色の鮮やかさ・純粋さの度合いです。
    -   彩度が0の場合、その色は白、黒、または灰色になります。

-   **しきい値の役割**
    -   ImageMagickは画像の平均彩度を `0` (完全な無彩色) から `1` (最も鮮やか) までの数値で計算します。
    -   `-SaturationThreshold` は、その判断の境界線となる値です。
    -   `平均彩度 < 0.05` ならば、グレースケールとして処理されます。

-   **なぜ `0` ではないのか？**
    -   スキャンした書籍の白いページは、完全に真っ白(彩度0)ではなく、わずかに色味を帯びている (例: 黄ばみ、インクのにじみ) ことがよくあります。
    -   しきい値を0にすると、こうした微妙な色味のせいで「カラー画像」と誤判定され、ファイルサイズが不必要に大きくなる可能性があります。
    -   `0.05` という値は、そうした微細な色ノイズを「誤差」とみなし、実質的に白黒のページを正しくグレースケールとして扱うための経験的な値です。

-   **この値を変更するケース**
    -   **ケース1: カラーの挿絵やマーカーがグレースケールに変換されてしまう場合**
        -   この値を少し下げてみてください (例: `0.03`)。しきい値が下がることで、より低い彩度でもカラーとして認識されるようになります。
    -   **ケース2: わずかな色味もカラーとして保持したい、またはグレースケールへの変換をより厳密にしたい場合**
        -   この値を下げてください (例: `0.01`)。

通常は、デフォルトの `0.05` のままで問題ありません。

### 詳細メッセージの表示

スクリプトの動作を詳しく確認したい場合や、問題が発生したときに原因を特定したい場合は、`-Verbose` オプションを指定してください。

**使用例:**
```powershell
# 詳細メッセージを表示しながら処理
pwsh -File .\JisuiArc2PDF.ps1 "MyBook.rar" -Verbose
```

## 使用方法

PowerShellターミナルを開き、`JisuiArc2PDF.ps1` スクリプトに処理したい書庫ファイルのワイルドカードパターンを引数として渡します。
ファイル名にスペースや日本語などの特殊文字が含まれる場合は、パスをシングルクォート `'` またはダブルクォート `"` で囲んでください。
7-zipで解凍できる形式の書庫（RAR, ZIPなど）をサポートしています。

### ワイルドカードを使用
`*` などのワイルドカードを使用して、特定のパターンのファイルを一括で処理できます。
```powershell
# 現在のフォルダにあるすべてのRARファイルを処理
pwsh -File .\JisuiArc2PDF.ps1 *.rar

# 特定のサブフォルダにあるすべてのZIPファイルを処理 
 (パスにスペース等が含まれる場合はダブルクォートで囲む)
pwsh -File .\JisuiArc2PDF.ps1 "C:\path\to\collections\*.zip"

# 親フォルダの他のディレクトリにあるすべてのRARファイルを処理
pwsh -File .\JisuiArc2PDF.ps1 "..\OtherFolder\*.rar"
```

## ログ機能

スクリプトは、PDF変換が成功するたびに、実行日時と変換に使用した設定をログファイルに自動で記録します。

-   **ログファイル名**: `JisuiArc2PDF_log.txt`
-   **場所**: スクリプト (`JisuiArc2PDF.ps1`) と同じフォルダに自動的に作成されます。
-   **形式**: 追記型。スクリプトを実行するたびに、新しいログがファイルの末尾に追加されます。

### ログの内容

各行には、以下の情報がカンマ区切りで記録されます。

1.  **処理日時**: `yyyy-MM-dd HH:mm:ss` 形式のタイムスタンプ
2.  **入力ファイル**: `Source: (元の書庫ファイル名)`
3.  **用紙サイズ** (指定した場合のみ): `PaperSize: (指定したサイズ)`
4.  **高さ**: `Height: (ピクセル数)px`
5.  **DPI**: `DPI: (DPI値)`
6.  **品質**: `Quality: (品質値)`
7.  **彩度しきい値**: `Saturation: (しきい値)`
8.  **出力ファイル**: `Output: (作成されたPDFのフルパス)`

このログにより、後からどの書籍をどのような設定でPDF化したかを正確に把握することができます。

## Paper Plane xUIから実行

変換対象ファイルをマークしてPPb経由で以下のように実行すると
ワイルドカードで一括指定して処理するのではなく
マークしたファイルに対して個別に処理できます。

```javascript
 %Os pwsh JisuiArc2PDF.ps1 %FC %:*trimmark
```

## 作成経緯について

このスクリプトおよびReadmeは、そのほとんど全てがGoogleのGemini CliおよびAlibaba CloudのQwen Codeといった生成AIの支援を受けて作成されました。

## ライセンス

このプロジェクトは [The Unlicense](LICENSE) のもとで公開されており、パブリックドメインに属します。