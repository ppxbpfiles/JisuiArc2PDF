# JisuiArc2PDF.ps1

**コマンドラインが苦手な方は、こちらの詳細なガイドをご覧ください: [使い方ガイド.md](使い方ガイド.md)**

複数の画像書庫ファイルを、画像の並び順を維持したまま高品質なPDFに変換するPowerShellスクリプトです。
7-zipで解凍できる形式の書庫（ZIP, RARなど）をサポートしており、本をスキャンしてアーカイブ形式でまとめた自炊書籍をPDFに変換することを想定しています。

## 概要

このスクリプトは、ワイルドカードパターン（例: `*.zip`）で指定された複数の書庫ファイルを個別に処理し、それぞれを一つのPDFファイルに変換します。アーカイブ内の画像ファイルを自然順（例: 1.jpg, 2.jpg, 10.jpg）に並べ替え、元のアーカイブと同じ名前のPDFを生成します。
7-zipで解凍できる形式の書庫（ZIP, RARなど）をサポートしています。

## 主な機能

-   **ワイルドカードによる複数ファイルの指定**: `*.zip` のようなワイルドカードパターンを指定して、複数の書庫ファイルを一度に処理できます。
-   **堅牢なパス解決**: スクリプト内部でワイルドカードを展開するため、シェルの挙動に依存せず安定して動作します。
-   **多様な画像形式に対応**: ImageMagickが認識できるすべての画像形式をサポートします。
-   **画像ファイルの自動選別**: 書庫内のファイルをImageMagickで順に識別し、**画像として認識されたファイルのみを処理対象**とし、画像以外のファイル（テキストファイルなど）は**自動的に無視されます**。
-   **インテリジェントな画像変換**:
    -   画像の彩度を自動で判別し、カラー画像とグレースケール画像をそれぞれ最適に処理します。
    -   画像はPDF化に適したサイズと解像度にリサイズされます。デフォルトでは**A4サイズ・144dpi相当（高さ1683px）**に設定されており、細かくカスタマイズ可能です。
    -   **インテリジェントなリサイズ**: 変換後の目標サイズ（`-Height` や `-PaperSize` で指定）よりも**縦ピクセルが元々小さい画像**は、画質の劣化を防ぐために**リサイズされません**。そのままの解像度でPDFに変換されます。
    -   **画質設定**: 生成されるJPEG画像の品質を調整できます。（デフォルト: 85）
-   **PDFの最適化**:
    -   `pdfcpu` を使用して、画像の結合、PDFの最適化、およびビューア設定の調整を自動で行います。
-   **ログ機能**: 変換が成功するたびに、使用した設定を `JisuiArc2PDF_log.txt` に自動で記録します。これにより、後からどのファイルがどの設定で変換されたかを確認できます。
-   **自然順ソート**: ファイル名に含まれる数字を数値として認識し、正しいページ順序でPDFを生成します。
-   **タイムスタンプの維持**: 生成されるPDFの作成日時と更新日時を、元のアーカイブファイルのものと一致させます。
-   **クリーンアップ**: 処理中に使用した一時ファイルは自動的に削除されます。

## 前提条件

### PowerShell バージョン
このスクリプトは `Start-Process` コマンドレットの `-RedirectStandardError` パラメータを使用しているため、**PowerShell 6.0 以上 (`pwsh.exe`)** が必要です。

-   **Windows:** [PowerShell 7](https://learn.microsoft.com/ja-jp/powershell/scripting/install/installing-powershell-on-windows) をインストールしてください。`pwsh.exe` でスクリプトを実行する必要があります。
-   **Linux / macOS:** PowerShell 6.0以上がインストールされていれば動作するかもしれません。

**動作確認について**
このスクリプトはクロスプラットフォームでの動作を意図して作られていますが、開発者による動作確認はWindows環境でのみ行われています。LinuxやmacOSでの動作は保証されていませんので、ご了承ください。

お使いのPowerShellのバージョンは、`pwsh -c "$PSVersionTable.PSVersion"` を実行することで確認できます。Windowsに標準搭載の `powershell.exe` (バージョン5.1) では動作しないためご注意ください。

### 必要なソフトウェア
このスクリプトを実行するには、以下のソフトウェアがインストールされている必要があります。

-   **ImageMagick**: 画像処理（リサイズ、品質調整、色空間変換）に使用します。
    -   `magick.exe` が必要です。
-   **7-Zip**: アーカイブファイルの展開に使用します。
    -   `7z.exe` と、それが動作するために必要な `7z.dll` が必要です。これらは通常、7-Zipをインストールしたフォルダに一緒に配置されています。
-   **PDFCPU**: 画像ファイルからPDFを生成・最適化するために使用します。
    -   `pdfcpu.exe` が必要です。

これらのソフトウェアは、以下のいずれかの方法で利用可能にしてください。
- **方法1 (推奨):** `JisuiArc2PDF.ps1` スクリプトファイルと同じフォルダに、`magick.exe`, `7z.exe`, `pdfcpu.exe` を配置してください。スクリプトはこれらのファイルを自動的に検出します。
- **方法2:** 各ソフトウェアをインストールし、その実行ファイルがシステムの環境変数PATHに登録されていることを確認してください。
    -   コマンドプロンプトやPowerShellで `magick -version`, `7z`, `pdfcpu version` を実行して、それぞれのバージョン情報が表示されれば、正しくPATHが通っています。（7zは引数なしで実行します）

## 設定

スクリプト実行時にオプションの引数を指定することで、画質や解像度を細かく制御できます。指定しない場合は、カッコ内のデフォルト値が使用されます。

### 解像度設定
変換される画像の縦方向の解像度（ピクセル数）を制御します。以下のいずれかの方法で指定できます。

-   `-Height <整数>` (エイリアス: `-h`)
    画像の高さをピクセル単位で直接指定します。

-   `-Dpi <整数>` (エイリアス: `-d`) および `-PaperSize <文字列>` (エイリアス: `-p`)
    画像のDPI（Dots Per Inch）と用紙サイズを指定します。`-Dpi` と `-PaperSize` は **同時に指定** する必要があります。
    -   `-PaperSize` で指定可能な値: `A0`, `A1`, `A2`, `A3`, `A4`, `A5`, `A6`, `A7`, `B0`, `B1`, `B2`, `B3`, `B4`, `B5`, `B6`, `B7`
    -   例: `.\JisuiArc2PDF.ps1 *.zip -p B5 -d 300`

**優先順位とデフォルトの挙動:**
1.  `-Height` が指定された場合、その値が最優先されます。
2.  `-Dpi` と `-PaperSize` が両方指定された場合、それらの値から高さが自動計算されます。
3.  何も指定されない場合、**A4サイズ・144dpi相当（高さ1683px）** がデフォルト値として使用されます。

**注意:**
- `-Dpi` または `-PaperSize` のみを指定した場合、エラーが発生します。両方を指定するか、またはどちらも指定しないでください。

**使用例:**
```powershell

# 高さを2000pxに直接指定
pwsh -File .\JisuiArc2PDF.ps1 *.zip -h 2000

# B5サイズ、300dpiで高さを自動計算
pwsh -File .\JisuiArc2PDF.ps1 *.zip -p B5 -d 300
```

### 画質と色判定の設定

-   `-Quality <整数>` (エイリアス: `-q`)
    PDFに変換される際の中間JPEG画像の品質を決定します。`1` から `100` の範囲で指定します。（デフォルト: `85`）
    -   値を大きくすると画質が向上しますが、ファイルサイズも増加します。
    -   値を小さくするとファイルサイズを削減できますが、画質は低下します。
    -   ImageMagickのJPEG品質設定の詳細については、[こちら](https://qiita.com/yoya/items/216d2fc98deb88fa7157)を参照してください。

-   `-SaturationThreshold <小数>` (エイリアス: `-s`, `-sat`)
    画像をグレースケールと判断する彩度のしきい値です。（デフォルト: `0.05`）

-   `-MinCompressionRatio <小数>` (エイリアス: `-mcr`)
    **画像1枚ごと**に圧縮結果を評価し、ファイルサイズと画質のバランスを最適化するためのオプションです。

    **動作の仕組み:**
    1. スクリプトは、書庫内の画像を1枚ずつ、指定された設定で変換・圧縮します。
    2. 変換後の**画像1枚**のファイルサイズを、変換前の**同じ画像**のファイルサイズと比較します。
    3. 変換後のサイズがこのオプションで指定したパーセンテージ（例: `95`）を**下回らなかった**場合（つまり、十分に圧縮できなかった場合）、スクリプトは**その画像の変換を破棄**し、代わりに**元の画像**をPDFのそのページに採用します。

    **ポイント:**
    - この判断は、**画像1枚ごと**に行われます。
    - これにより、最終的なPDFは、ページごとに「圧縮後の画像」と「元の画像」が混在した、最適な構成になります。
    - 圧縮効果が薄い画像（例えば、すでに高度に圧縮されている画像や、線画が中心の画像など）で、不必要な画質劣化が起きるのを防ぎます。

    このオプションを使用しない場合、このチェックは行われません。

-   `-SkipCompression` (エイリアス: `-sc`)
    このスイッチを指定すると、リサイズや品質変更などのすべての画像圧縮処理をスキップします。元画像がそのままPDFに変換されます。`-Height` や `-Quality` などの設定は無視されます。

**使用例:**
```powershell

# 短いエイリアスを使い、品質を95に設定して実行
pwsh -File .\JisuiArc2PDF.ps1 "MyBook.zip" -q 95

# 品質と彩度しきい値の両方を指定
pwsh -File .\JisuiArc2PDF.ps1 "MyBook.zip" -Quality 92 -SaturationThreshold 0.03
```

#### `-SaturationThreshold` の詳細

このスクリプトは、画像1枚ごとの「平均彩度」を計算し、その値がここで設定したしきい値（Threshold）より低いかどうかで、カラー画像かグレースケール画像かを判断します。

-   **彩度とは？**
    -   色の鮮やかさ・純粋さの度合いです。
    -   彩度が0の場合、その色は白、黒、または灰色になります。

-   **しきい値の役割**
    -   ImageMagickは画像の平均彩度を `0` (完全な無彩色) から `1` (最も鮮やか) までの数値で計算します。
    -   `-SaturationThreshold` は、その判断の境界線となる値です。
    -   `平均彩度 < 0.05` ならば、グレースケールとして処理されます。

-   **なぜ `0` ではないのか？**
    -   スキャンした書籍の白いページは、完全に真っ白(彩度0)ではなく、わずかに色味を帯びている (例: 黄ばみ、インクのにじみ) ことがよくあります。
    -   しきい値を0にすると、こうした微妙な色味のせいで「カラー画像」と誤判定され、ファイルサイズが不必要に大きくなる可能性があります。
    -   `0.05` という値は、そうした微細な色ノイズを「誤差」とみなし、実質的に白黒のページを正しくグレースケールとして扱うための経験的な値です。

-   **この値を変更するケース**
    -   **ケース1: カラーの挿絵やマーカーがグレースケールに変換されてしまう場合**
        -   この値を少し下げてみてください (例: `0.03`)。しきい値が下がることで、より低い彩度でもカラーとして認識されるようになります。
    -   **ケース2: わずかな色味もカラーとして保持したい、またはグレースケールへの変換をより厳密にしたい場合**
        -   この値を下げてください (例: `0.01`)。

通常は、デフォルトの `0.05` のままで問題ありません。

### 詳細メッセージの表示

スクリプトの動作を詳しく確認したい場合や、問題が発生したときに原因を特定したい場合は、`-Verbose` オプションを指定してください。

**使用例:**
```powershell

# 詳細メッセージを表示しながら処理
pwsh -File .\JisuiArc2PDF.ps1 "MyBook.zip" -Verbose
```

## 使用方法

PowerShellターミナルを開き、`JisuiArc2PDF.ps1` スクリプトに処理したい書庫ファイルのワイルドカードパターンを引数として渡します。
ファイル名にスペースや日本語などの特殊文字が含まれる場合は、パスをシングルクォート `'` またはダブルクォート `"` で囲んでください。
7-zipで解凍できる形式の書庫（ZIP, RARなど）をサポートしています。

### ワイルドカードを使用
`*` などのワイルドカードを使用して、特定のパターンのファイルを一括で処理できます。
```powershell

# 現在のフォルダにあるすべてのZIPファイルを処理
pwsh -File .\JisuiArc2PDF.ps1 *.zip

# 特定のサブフォルダにあるすべてのRARファイルを処理 
 (パスにスペース等が含まれる場合はダブルクォートで囲む)
pwsh -File .\JisuiArc2PDF.ps1 "C:\path\to\collections\*.rar"

# 親フォルダの他のディレクトリにあるすべてのRARファイルを処理
pwsh -File .\JisuiArc2PDF.ps1 "..\OtherFolder\*.rar"
```

### 総合的な使用例

複数のオプションを組み合わせて、より細かく変換プロセスを制御することができます。

```powershell

# エイリアスを使い、複数の設定を組み合わせて実行する例
pwsh -File .\JisuiArc2PDF.ps1 "C:\Scans\*.zip" -p B5 -d 300 -q 92 -s 0.04 -mcr 95 -v
```

このコマンドは、以下の処理を実行します。

-   **対象**: `C:\Scans\` フォルダ内にある、すべての `.zip` ファイル。
-   **解像度**: `-p B5 -d 300`
    -   B5用紙サイズ、300 DPIに設定して画像をリサイズします。
-   **画質**: `-q 92`
    -   JPEG品質を `92` に設定します。デフォルト(85)より高画質になります。
-   **色判定**: `-s 0.04`
    -   グレースケールと判定する彩度のしきい値を `0.04` に下げます。これにより、非常に薄い色もカラーとして保持されやすくなります。
-   **圧縮制御**: `-mcr 95`
    -   画像1枚ごとに圧縮率をチェックします。もし変換によってサイズが5%以上減少しなかった（サイズが元の95%以上だった）場合、そのページは画質劣化を避けるために元の画像が使われます。
-   **詳細表示**: `-v`
    -   `-Verbose` フラグを有効にし、コンソールに詳細な処理状況を出力させます。

## バッチファイルによる対話的な実行 (JisuiArc2PDF.bat)

コマンドラインの操作に慣れていない方向けに、対話形式で変換設定を行えるバッチファイル `JisuiArc2PDF.bat` を同梱しています。

### 主な機能
-   実行すると、圧縮をスキップするか、画質、解像度などを順番に質問されます。
-   数値を入力したり、Enterキーでデフォルト値を選択したりするだけで、複雑なコマンドを組み立てることができます。
-   最後に、実行されるPowerShellコマンドのプレビューが表示され、Enterキーを押すと処理が開始されます。

### 使い方
-   **方法1（推奨）:** 処理したい書庫ファイル（`.rar`, `.zip`など）を、`JisuiArc2PDF.bat` のアイコン上にドラッグ＆ドロップします。
-   **方法2:** `cmd.exe` やエクスプローラーのアドレスバーから、`JisuiArc2PDF.bat "対象ファイル"` のように実行します。（例: `JisuiArc2PDF.bat "*.zip"`）

### **重要**: 前提条件
このバッチファイルを実行するには、お使いのシステムで `pwsh.exe` がどこからでも呼び出せる状態になっている必要があります。

-   **PowerShell 7 (pwsh.exe) がインストールされていること。**
-   **インストール時に「PATH環境変数にPowerShellを追加する」といったオプションを有効にしていること。**

`コマンドプロンプト`または`ファイル名を指定して実行`（Win+R）で `pwsh` と入力してPowerShellが起動すれば、準備OKです。起動しない場合は、PowerShellを再インストールし、PATH環境変数への追加オプションを有効にしてください。

## ログ機能


スクリプトは、PDF変換が成功するたびに、実行日時、使用した設定、および各ページの処理内訳をログファイルに自動で記録します。

-   **ログファイル名**: `JisuiArc2PDF_log.txt`
-   **場所**: スクリプト (`JisuiArc2PDF.ps1`) と同じフォルダに自動的に作成されます。
-   **形式**: 追記型。スクリプトを実行するたびに、新しいログがファイルの末尾に追加されます。

### ログの構造

ログは、**実行コマンドライン**、**サマリー行**、そしてそれに続く**詳細行**で構成されます。

#### 実行コマンドライン
ログの最初に、スクリプトを実行した際のコマンドラインがそのまま記録されます。これにより、後からコマンドをコピー＆ペーストして、まったく同じ設定で再実行することが容易になります。
- `Command: (実行したコマンドライン)`

#### サマリー行
次に、処理全体に関する情報が1行にまとめてカンマ区切りで記録されます。

1.  **処理日時**: `yyyy-MM-dd HH:mm:ss` 形式のタイムスタンプ
2.  **入力ファイル**: `Source: (元の書庫ファイル名)`
3.  **用紙サイズ** (指定した場合のみ): `PaperSize: (指定したサイズ)`
4.  **圧縮率しきい値** (指定した場合のみ): `MinCompressionRatio: (しきい値)`
5.  **高さ**: `Height: (ピクセル数)px`
6.  **DPI**: `DPI: (DPI値)`
7.  **品質**: `Quality: (品質値)`
8.  **彩度しきい値**: `Saturation: (しきい値)`
9.  **画像サマリー**: `Images: (総数) (Converted: (変換数), Originals: (元画像数))`
10. **出力ファイル**: `Output: (作成されたPDFのフルパス)`

#### 詳細行
サマリー行の直後には、インデント（字下げ）された詳細行が続きます。ここには、画像1枚ごとの処理結果が記録されます。

-   `    - (元画像ファイル名): Converted (Ratio: XX.XX %)`
    -   画像が設定通りに変換されたことを示します。カッコ内に、元画像に対する変換後画像のサイズ比率が表示されます。
-   `    - (元画像ファイル名): Original (Ratio: XX.XX %)`
    -   `-MinCompressionRatio` オプションにより、変換後のファイルサイズが大きかった（または十分に小さくならなかった）ため、元画像がそのまま使用されたことを示します。カッコ内にも同様にサイズ比率が表示されます。

### ログの例
```
Command: pwsh -File .\JisuiArc2PDF.ps1 MyBook.zip -mcr 95
2025-08-22 18:30:00, Source: MyBook.zip, PaperSize: A4, MinCompressionRatio: 95, Height: 1683px, DPI: 144, Quality: 85, Saturation: 0.05, Images: 152 (Converted: 148, Originals: 4), Output: C:\Path\To\MyBook.pdf
    - 001.jpg: Converted (Ratio: 55.12 %)
    - 002.jpg: Converted (Ratio: 61.40 %)
    ...
    - 085.jpg: Original (Ratio: 99.85 %)
    - 086.jpg: Converted (Ratio: 58.91 %)
    ...
```
このログにより、どの設定でPDFが作成され、どのページが圧縮され、どのページが元のまま残されたかを正確に把握することができます。

## Paper Plane xUIから実行

変換対象ファイルをマークしてPPb経由で以下のように実行すると
ワイルドカードで一括指定して処理するのではなく
マークしたファイルに対して個別に処理できます。

```javascript
 %Os pwsh JisuiArc2PDF.ps1 %FC %:*trimmark
```

## 作成経緯について

このスクリプトおよびReadmeは、そのほとんど全てがGoogleの Gemini CLI およびAlibaba Cloudの Qwen Code といった生成AIの支援を受けて作成されました。

## ライセンス

このプロジェクトは [The Unlicense](LICENSE) のもとで公開されており、パブリックドメインに属します。
