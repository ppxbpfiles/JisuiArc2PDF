# JisuiArc2PDF.py

**コマンドラインが苦手な方は、こちらの詳細なガイドをご覧ください: [使い方ガイド_python.md](使い方ガイド_python.md)**

複数の画像書庫ファイルを、画像の並び順を維持したまま高品質なPDFに変換するPythonスクリプトです。
7-zipで解凍できる形式の書庫（ZIP, RARなど）をサポートしており、本をスキャンしてアーカイブ形式でまとめた自炊書籍をPDFに変換することを想定しています。

## 主な機能

（省略）

## クロスプラットフォーム対応

このPythonスクリプトは、Windows, macOS, Linuxで動作するように設計されています。

-   **スクリプト本体 (`JisuiArc2PDF.py`)**: OSに依存しないため、どの環境でも同じように動作します。
-   **バッチファイル (`JisuiArc2PDF_py.bat`)**: **Windows専用**です。macOSやLinuxでは、ターミナルから直接 `python3 JisuiArc2PDF.py ...` のようにコマンドを実行してください。

## 前提条件

### Python バージョン
- **Python 3.8 以上** の実行環境が必要です。
- OSに付属の`python`コマンドではなく、[Python公式サイト](https://www.python.org/)からダウンロードした`python3`の使用を推奨します。

### 必要な外部ツール
このスクリプトの動作には、以下の外部ツールが必要です。

-   **7-Zip**: 書庫ファイルの展開に使用 (macOS/Linuxでは `p7zip`)
-   **ImageMagick**: 画像処理（リサイズ、品質調整、色空間変換）に使用
-   **PDFCPU**: 画像ファイルからPDFを生成・最適化するために使用
-   **QPDF** (任意): PDFのリニアライズ（ウェブ最適化）処理に使用

--- 

## 環境構築

### Windows
- **方法1 (推奨: ポータブル実行):** スクリプトと同じフォルダに必要な実行ファイルを配置します。PC環境に依存せず、このフォルダだけで完結するのが利点です。
    - **Python**: [Python公式サイト](https://www.python.org/downloads/windows/)から `Windows embeddable package` をダウンロードして展開します。
    - **ImageMagick**: 公式サイトから **static 版** (`...-static-x64.zip`など) をダウンロードしてください。`magick.exe` という単一のファイルで動作し、DLLは不要なため最もシンプルです。
    - **7-Zip**: `7z.exe` と `7z.dll` を配置します。
    - **PDFCPU**: `pdfcpu.exe` を配置します。
    - **QPDF (任意)**: `--Linearize`機能を使う場合は `qpdf.exe` と関連DLLを配置します。
- **方法2 (インストールして使用):** 各ツールをPCにインストールし、実行ファイルへのPATHを通します。

### macOS (Homebrewを使用)
[Homebrew](https://brew.sh/index_ja)がインストールされている場合、ターミナルで以下のコマンドを実行して必要なツールをインストールできます。

```bash
# p7zip(7-Zip), imagemagick, qpdfをインストール
brew install p7zip imagemagick qpdf

# pdfcpuをインストール
brew install pdfcpu
```

### Linux (Debian / Ubuntu の場合)
ターミナルで以下のコマンドを実行して必要なツールをインストールできます。

```bash
# p7zip-full(7-Zip), imagemagick, qpdfをインストール
sudo apt update
sudo apt install p7zip-full imagemagick qpdf -y
```

**LinuxでのPDFCPUのインストール:**
`pdfcpu`はAPTリポジトリにないため、[公式サイトのリリース](https://pdfcpu.io/download)から最新のLinux用バイナリをダウンロードし、パスの通ったディレクトリ（例: `/usr/local/bin`）に配置してください。

--- 

## 使用方法

ターミナル（コマンドプロンプト, PowerShell, bashなど）を開き、`python3 JisuiArc2PDF.py` コマンドに処理したい書庫ファイルのパスを渡します。

```bash
# 現在のフォルダにあるすべてのZIPファイルを処理
python3 JisuiArc2PDF.py *.zip

# 特定のサブフォルダにあるすべてのRARファイルを処理
python3 JisuiArc2PDF.py "/path/to/collections/*.rar"
```

### 解像度設定
変換される画像の縦方向の解像度（ピクセル数）を制御します。以下のいずれかの方法で指定できます。

-   `--Height <整数>` (エイリアス: `-h`)
    画像の高さをピクセル単位で直接指定します。

-   `--Dpi <整数>` (エイリアス: `-d`) および `--PaperSize <文字列>` (エイリアス: `-p`)
    画像のDPI（Dots Per Inch）と用紙サイズを指定します。`--Dpi` と `--PaperSize` は **同時に指定** する必要があります。
    -   `--PaperSize` で指定可能な値: `A0`, `A1`, `A2`, `A3`, `A4`, `A5`, `A6`, `A7`, `B0`, `B1`, `B2`, `B3`, `B4`, `B5`, `B6`, `B7`
    -   例: `python3 JisuiArc2PDF.py *.zip -p B5 -d 300`

**優先順位とデフォルトの挙動:**
1.  `--Height` が指定された場合、その値が最優先されます。
2.  `--Dpi` と `--PaperSize` が両方指定された場合、それらの値から高さが自動計算されます。
3.  何も指定されない場合、**A4サイズ・144dpi相当（高さ1683px）** がデフォルト値として使用されます。

**注意:**
- `--Dpi` または `--PaperSize` のみを指定した場合、エラーが発生します。両方を指定するか、またはどちらも指定しないでください。

#### **【ヒント】最適な解像度の選び方**

-   **デフォルト設定（144dpi）はほとんどの用途で最適です**
    -   このスクリプトの主な目的は「デジタル端末の画面で読む」ことです。144dpi（A4で高さ約1680px）は、一般的なPCモニターやタブレットで快適に読める画質と、大きすぎないファイルサイズを両立できる、非常にバランスの取れた設定です。**特にこだわりがなければ、まずはデフォルトのままお試しください。**

-   **4Kモニターなど高精細ディスプレイの場合**
    -   4K（縦2160px）のような高精細モニターで全画面表示すると、144dpiの画像は少し引き伸ばされるため、文字の輪郭が甘く感じられる（粗さが目立つ）ことがあります。
    -   最高の画質を求める場合は、**高さを2200px〜2400px程度に設定する**のがおすすめです。`--Height 2200` のように直接指定するのが簡単です。
    -   `python3 JisuiArc2PDF.py *.zip --Height 2200`

-   **印刷が目的の場合**
    -   もしPDFを印刷する可能性があるなら、**300dpi**（`--Dpi 300`）を基準に設定してください。これが商業印刷でも使われる標準的な解像度です。

**使用例:**
```bash
# 高さを2000pxに直接指定
python3 JisuiArc2PDF.py *.zip -h 2000

# B5サイズ、300dpiで高さを自動計算
python3 JisuiArc2PDF.py *.zip -p B5 -d 300
```

スクリプトはカラーページと白黒ページを自動で判別し、それぞれに最適なコントラスト調整を適用できます。

-   `--AutoContrast` (エイリアス: `-ac`)
    **カラーページ**のコントラストを自動で最適化します。ImageMagickの`-normalize`機能を使用し、画像の明るさの範囲を最大化します。
    -   このスイッチを指定すると、`--ColorContrast`オプションは無視されます。

-   `--GrayscaleLevel <文字列>` (エイリアス: `-gl`)
    **グレースケール（白黒）ページ**に適用されるコントラスト調整です。ImageMagickの`-level`機能を使い、紙焼け（背景の黄ばみ）除去に効果的です。
    -   `10%,90%` のように、黒点と白点をパーセンテージで指定します。

-   `--ColorContrast <文字列>` (エイリアス: `-cc`)
    **カラーページ**に適用されるコントラストを手動で調整します。ImageMagickの`-brightness-contrast`機能を使います。
    -   `--AutoContrast`が指定されていない場合のみ有効です。
    -   `0x25` のように、`明るさxコントラスト`をパーセントで指定します。この例では、明るさを0%（変更なし）、コントラストを25%上げます。

### ログ機能

スクリプトは、PDF変換が成功するたびに、実行日時、使用した設定、および各ページの処理内訳をログファイルに自動で記録します。

-   **ログファイル名**: `JisuiArc2PDF_py_log.txt`
-   **場所**: デフォルトではスクリプト (`JisuiArc2PDF.py`) と同じフォルダに作成されますが、`--LogPath` オプションで出力先ディレクトリやファイルパスを自由に変更できます。
-   **形式**: 追記型。スクリプトを実行するたびに、新しいログがファイルの末尾に追加されます。

#### ログの構造

ログは、**実行コマンドライン**、**サマリー行**、そしてそれに続く**詳細行**で構成されます。

- **実行コマンドライン**: スクリプトを実行した際のコマンドラインがそのまま記録されます。各ログブロックの先頭にあります。
  - `Command: python JisuiArc2PDF.py ...`

- **サマリー行**: `キー="値"` 形式で、処理結果の要約が1行で記録されます。
  - `Timestamp`: 処理が完了した日時
  - `Status`: 処理結果 (`Success` または `Success with pages skipped`)
  - `Source`: 元の書庫ファイル名
  - `Output`: 作成されたPDFのフルパス
  - `Images`: 書庫内で認識された画像の総数
  - `Converted`: 変換が適用された画像の数
  - `Originals`: 元の画像が使われた数
  - `Skipped`: 処理に失敗し、PDFから除外された画像の数
  - `Settings`: 実行時に使用された主要な設定のリスト

- **詳細行**: インデントされた詳細行には、画像1枚ごとの処理結果が記録されます。
  - `    - (ファイル名): Converted ...`: 画像が設定通りに変換されたことを示します。
  - `    - (ファイル名): Original ...`: ファイルサイズ比較の結果、元画像が使用されたことを示します。
  - `    - (ファイル名): SKIPPED ...`: ファイルの変換に失敗し、このページがPDFから**除外された**ことを示します。

#### ログの例

```text
Command: python JisuiArc2PDF.py .\MyBook.zip -tcr 95
Timestamp="2025-08-23 19:00:00" Status="Success with pages skipped" Source="MyBook.zip" Output="C:\Path\To\MyBook.pdf" Images=152 Converted=148 Originals=0 Skipped=4 Settings="TCR:95, Height:1683px, DPI:144, Quality:85, ..."
    - 001.jpg: Converted (Ratio: 55.12 %)
    - 002.jpg: Converted (Ratio: 61.40 %)
    - 003.jpg: SKIPPED (File conversion failed)
    ...
```

#### ログから処理結果を判断する方法

ログファイルに**処理した書庫ファイルに関する記録が残っているかどうか**で、そのファイルの処理が成功したか失敗したかを判断できます。

-   **ページ抜け（一部失敗）の確認**: サマリー行の `Skipped=` の数が`0`より大きい場合、そのPDFには**ページ抜けが発生しています。** 詳細行で `SKIPPED` となっているファイルを確認できます。
-   **完全な失敗の確認**: 処理中にスクリプトが異常終了した場合、そのファイルに関するログは**一切書き込まれません。**

| 状態 | ログのサマリー行 |
| :--- | :--- |
| **完全な成功** | `Status="Success"` かつ `Skipped=0` |
| **ページ抜け** | `Status="Success with pages skipped"` かつ `Skipped`が1以上 |
| **完全な失敗** | 対象ファイルのログブロック自体が**存在しない** |

### 総合的な使用例

複数のオプションを組み合わせて、より細かく変換プロセスを制御することができます。

#### 使用例1: 高画質・高圧縮、全自動補正（推奨設定）
画質を維持しつつ、可能な限りの補正と圧縮をバランス良く行う、最も標準的で推奨される設定です。

```bash
python3 JisuiArc2PDF.py "C:\Scans\*.zip" -p B5 -d 300 -q 92 --GrayscaleLevel "10%,90%" -ac --Deskew --Trim -tcr 95 -v
```

このコマンドは、以下の処理を実行します。
-   **対象**: `C:\Scans\` フォルダ内にある、すべての `.zip` ファイル。
-   **解像度**: `-p B5 -d 300` → B5用紙サイズ、300 DPIに設定してリサイズします。
-   **画質**: `-q 92` → JPEG品質を `92` に設定します。デフォルト(85)より高画質になります。
-   **コントラスト**: `--GrayscaleLevel "10%,90%" -ac` → 白黒ページは紙焼けを補正し、カラーページはコントラストを自動調整します。
-   **補正**: `--Deskew` と `--Trim` で傾きと余白を自動補正します。
-   **圧縮制御**: `-tcr 95` → 変換後の合計サイズが元の95%未満にならなかった場合は、画質維持を優先します。
-   **詳細表示**: `-v` → コンソールに詳細な処理状況を出力させます。

---

#### 使用例2: 品質最優先（画集・雑誌向け）
解像度とJPEG品質を高く設定し、ファイルサイズよりも画質を最優先します。カラーイラストや写真が多い書籍に適しています。

```bash
python3 JisuiArc2PDF.py "/path/to/Artbooks/*.rar" -h 2400 -q 98 -ac -ds --TotalCompressionThreshold 99
```
-   **解像度**: `-h 2400` → 高さを2400pxに固定します。
-   **画質**: `-q 98` → JPEG品質を `98` に設定し、圧縮ノイズを最小限に抑えます。
-   **コントラスト**: `-ac` → カラーページのコントラストを自動で最適化します。
-   **傾き補正**: `-ds` → 傾きを補正します。
-   **圧縮制御**: `--TotalCompressionThreshold 99` → ファイルサイズがほとんど減らない場合でも、リサイズと補正の結果を適用します。

---

#### 使用例3: 漫画・コミック向け（サイズと品質のバランス）
漫画の単行本（B6サイズなど）に多い設定です。解像度を少し抑え、紙焼け補正を少し強めに設定することで、読みやすさとファイルサイズのバランスを取ります。

```bash
python3 JisuiArc2PDF.py "./Manga/*.zip" -p B6 -d 200 -q 88 -gl "15%,85%" -ac -ds
```
-   **解像度**: `-p B6 -d 200` → B6サイズ、200 DPIに設定。一般的なディスプレイで読むには十分な解像度です。
-   **画質**: `-q 88` → 標準的な品質設定です。
-   **コントラスト**: `-gl "15%,85%" -ac` → 白黒ページの紙焼け補正を少し強めにかけ、古い漫画の黄ばみを目立たなくします。カラーページは自動調整します。
-   **傾き補正**: `-ds` → 傾きを補正します。



## バッチファイルによる対話的な実行 (JisuiArc2PDF_py.bat)

**Windowsユーザー向け**の機能です。コマンドラインに慣れていない方向けに、対話形式で設定を行えるバッチファイル `JisuiArc2PDF_py.bat` を同梱しています。

-   **使い方**: 処理したい書庫ファイル（`.rar`, `.zip`など）を、`JisuiArc2PDF_py.bat` のアイコン上にドラッグ＆ドロップします。
-   **前提条件**: この機能を利用するには、PythonがPCにインストールされ、PATHが通っている必要があります。