# JisuiArc2PDF.py

**コマンドラインが苦手な方は、こちらの詳細なガイドをご覧ください: [使い方ガイド_python.md](使い方ガイド_python.md)**

複数の画像書庫ファイルを、画像の並び順を維持したまま高品質なPDFに変換するPythonスクリプトです。
7-zipで解凍できる形式の書庫（ZIP, RARなど）をサポートしており、本をスキャンしてアーカイブ形式でまとめた自炊書籍をPDFに変換することを想定しています。

## 概要

このスクリプトは、ワイルドカードパターン（例: `*.zip`）で指定された複数の書庫ファイルを個別に処理し、それぞれを一つのPDFファイルに変換します。アーカイブ内の画像ファイルを自然順（例: 1.jpg, 2.jpg, 10.jpg）に並べ替え、元のアーカイブと同じ名前のPDFを生成します。
7-zipで解凍できる形式の書庫（ZIP, RARなど）をサポートしています。

## 注意事項

-   **ファイルの上書き**: 出力先に同名のPDFファイルが既に存在する場合、スクリプトは**ユーザーに確認することなく、そのファイルを上書きします。** 重要なファイルを誤って上書きしないように、事前に出力先フォルダをご確認ください。

## 主な機能

-   **ワイルドカードによる複数ファイルの指定**: `*.zip` のようなワイルドカードパターンを指定して、複数の書庫ファイルを一度に処理できます。
-   **堅牢なパス解決**: スクリプト内部でワイルドカードを展開するため、シェルの挙動に依存せず安定して動作します。
-   **多様な画像形式に対応**: ImageMagickが認識できるすべての画像形式をサポートします。
-   **画像ファイルの自動選別**: 書庫内のファイルをImageMagickで順に識別し、**画像として認識されたファイルのみを処理対象**とし、画像以外のファイル（テキストファイルなど）は**自動的に無視されます**。
-   **インテリジェントな画像変換**:
    画像の変換は、おおよそ以下の順序で行われます。各工程はオプションで有効/無効を切り替えられます。
    `[元画像]` → `傾き補正` → `余白除去` → `リサイズ` → `コントラスト/色調補正` → `[変換後画像]`
    -   画像の彩度を自動で判別し、カラー画像とグレースケール画像をそれぞれ最適に処理します。
    -   画像はPDF化に適したサイズと解像度にリサイズされます。デフォルトでは**A4サイズ・144dpi相当（高さ1683px）**に設定されており、細かくカスタマイズ可能です。
    -   **インテリジェントなリサイズ**: 変換後の目標サイズ（`--Height` や `--PaperSize` で指定）よりも**縦ピクセルが元々小さい画像**は、画質の劣化を防ぐために**リサイズされません**。そのままの解像度でPDFに変換されます。
-   **最適なファイルサイズの自動選択（2段階比較）**:
    画質とファイルサイズのバランスを取るため、以下の2段階の比較処理を自動で行います。
    1.  **ステップ1: ピクセルサイズの比較（個別リサイズ）**
        -   まず、書庫内の画像1枚ごとに、設定された目標の高さ（例: 2000px）と画像の実際の高さを比較します。
        -   画像が目標より大きい場合のみ、目標の高さに縮小されます。これにより、不必要な画質の劣化（アップスケール）を防ぎます。
        -   この処理を経た画像群が「変換後ファイル」として一時的に保存されます。
    2.  **ステップ2: 合計ファイルサイズの比較（一括選択）**
        -   次に、「元の全画像」の合計ファイルサイズと、「変換後の全画像」の合計ファイルサイズを比較します。
        -   比較の結果、「変換後」のファイルセットを採用するか、「元」のファイルセットを採用するかが決まります。（この判断は `--TotalCompressionThreshold` オプションで制御できます）
        -   **重要**: 「元」のファイルセットを採用すると判断された場合でも、元のファイルがそのまま使われるわけではありません。この場合、元のファイル（例: WEBP, PNG, AVIF）は**リサイズされずにJPEG形式へ変換**されます。その際、**通常の変換処理と同様に彩度チェックが行われ、グレースケールと判断された画像はグレースケール化されます。** これにより、PDF非対応の形式が処理できるだけでなく、画質を維持しつつファイルサイズも最適化されます。
            -   **【補足】なぜ既に白黒の画像もグレースケール化するのか？**
                このパススルー処理では、元々グレースケールだった画像に対しても、改めてグレースケール化の指示が出されます。これは意図された動作で、元のファイルが「カラー形式だが中身は白黒」のような場合でも、確実にファイルサイズが最適な「グレースケール形式のJPEG」として出力するための正規化処理です。既にグレースケールの画像にこの処理を行っても、画質が劣化することはありません。
        この「すべて変換するか、すべて元のままか」という一括判断により、一部の画像だけが圧縮されて画質が不均一になることを防ぎ、全体として最もファイルサイズが小さくなる選択が保証されます。
-   **PDFの最適化とビューア設定**:
    -   `pdfcpu` を使用して、PDFの最適化とビューア設定（ドキュメントタイトルの表示など）を自動で行います。
-   **ログ機能**: 変換が成功するたびに、使用した設定を `JisuiArc2PDF_py_log.txt` に自動で記録します。これにより、後からどのファイルがどの設定で変換されたかを確認できます。
-   **自然順ソート**: ファイル名に含まれる数字を数値として認識し、正しいページ順序でPDFを生成します。
-   **タイムスタンプの維持**: 生成されるPDFの作成日時と更新日時を、元のアーカイブファイルのものと一致させます。
-   **傾きの自動補正**: `--Deskew` オプションにより、スキャン時に生じた画像のわずかな傾きを自動で検出・補正します。
-   **クリーンアップ**: 処理中に使用した一時ファイルは自動的に削除されます。

## 前提条件

### Python バージョン
- **Python 3.8 以上** の実行環境が必要です。
- OSに付属の`python`コマンドではなく、[Python公式サイト](https://www.python.org/)からダウンロードした`python3`の使用を推奨します。

### 必要なソフトウェア
このスクリプトを実行するには、以下のソフトウェアがインストールされている必要があります。

-   **ImageMagick**: 画像処理（リサイズ、品質調整、色空間変換）に使用します。
-   **7-Zip**: アーカイブファイルの展開に使用します。
-   **PDFCPU**: 画像ファイルからPDFを生成・最適化するために使用します。
-   **QPDF** (オプション): PDFのリニアライズ（Fast Web View、Web表示用に最適化）処理に使用されます。

これらのソフトウェアは、以下のいずれかの方法で利用可能にしてください。
- **方法1 (推奨: ポータブル実行):** スクリプトと同じフォルダに必要な実行ファイルを配置します。PC環境に依存せず、このフォルダだけで完結するのが利点です。
- **方法2 (インストールして使用):** 各ソフトウェアをPCにインストールし、実行ファイルへのPATHを通します。

## 設定

スクリプト実行時にオプションの引数を指定することで、画質や解像度を細かく制御できます。指定しない場合は、デフォルト値が使用されます。

### 解像度設定
変換される画像の縦方向の解像度（ピクセル数）を制御します。以下のいずれかの方法で指定できます。

-   `--Height <整数>` (エイリアス: `-H`)
    画像の高さをピクセル単位で直接指定します。

-   `--Dpi <整数>` (エイリアス: `-d`) および `--PaperSize <文字列>` (エイリアス: `-p`)
    画像のDPI（Dots Per Inch）と用紙サイズを指定します。`--Dpi` と `--PaperSize` は **同時に指定** する必要があります。
    -   `--PaperSize` で指定可能な値: `A0`, `A1`, `A2`, `A3`, `A4`, `A5`, `A6`, `A7`, `B0`, `B1`, `B2`, `B3`, `B4`, `B5`, `B6`, `B7`
    -   例: `python3 JisuiArc2PDF.py *.zip -p B5 -d 300`

**優先順位とデフォルトの挙動:**
1.  `--Height` が指定された場合、その値が最優先されます。
2.  `--Dpi` と `--PaperSize` が両方指定された場合、それらの値から高さが自動計算されます。
3.  何も指定されない場合、**A4サイズ・144dpi相当（高さ1683px）** がデフォルト値として使用されます。

**注意:**
- `--Dpi` または `--PaperSize` のみを指定した場合、エラーが発生します。両方を指定するか、またはどちらも指定しないでください。

#### **【ヒント】解像度とページサイズの関係について**

「`--PaperSize`や`--SetPageSize`を設定すると、画像の解像度は変わるの？」という疑問について。

このスクリプトの画像処理は、大きく分けて2段階で行われます。

1.  **ステップ1: 画像のリサイズ (ImageMagick)**
    *   まず、`--Height`や`--PaperSize`の設定に基づいて、画像のピクセル数が変更されます（例: 3000x4000ピクセル → 1200x1600ピクセル）。
    *   **この時点で、画像の「解像度（ピクセル数）」は確定します。**

2.  **ステップ2: PDFページの作成 (`pdfcpu`)**
    *   次に、`pdfcpu`が、ステップ1で作成された画像ファイルを受け取ります。
    *   `--SetPageSize`を指定して`f:A4`のような設定を渡すと、`pdfcpu`は「**A4サイズ（210mm x 297mm）の白紙のページ**」を用意し、その上にステップ1の画像を配置します。

つまり、`--SetPageSize`は画像のピクセルを直接変更するわけではなく、「どの大きさの紙に画像を配置するか」を決めるだけの設定です。画像の最終的な精細さ（DPI）は、ステップ1のリサイズ設定（`--Height`や`--Dpi`）によって決まります。

#### **【ヒント】最適な解像度の選び方**

-   **デフォルト設定（144dpi）はほとんどの用途で最適です**
    -   このスクリプトの主な目的は「デジタル端末の画面で読む」ことです。144dpi（A4で高さ約1680px）は、一般的なPCモニターやタブレットで快適に読める画質と、大きすぎないファイルサイズを両立できる、非常にバランスの取れた設定です。**特にこだわりがなければ、まずはデフォルトのままお試しください。**

-   **4Kモニターなど高精細ディスプレイの場合**
    -   4K（縦2160px）のような高精細モニターで全画面表示すると、144dpiの画像は少し引き伸ばされるため、文字の輪郭が甘く感じられる（粗さが目立つ）ことがあります。
    -   最高の画質を求める場合は、**高さを2200px〜2400px程度に設定する**のがおすすめです。`--Height 2200` のように直接指定するのが簡単です。
    -   `python3 JisuiArc2PDF.py *.zip --Height 2200`

-   **印刷が目的の場合**
    -   もしPDFを印刷する可能性があるなら、**300dpi**（`--Dpi 300`）を基準に設定してください。これが商業印刷でも使われる標準的な解像度です。

### 画質と圧縮制御の設定

-   `--Quality <整数>` (エイリアス: `-q`)
    PDFに変換される際の中間JPEG画像の品質を決定します。`1` から `100` の範囲で指定します。（デフォルト: `85`）

-   `--SaturationThreshold <小数>` (エイリアス: `-s`)
    画像をグレースケールと判断する彩度のしきい値です。（デフォルト: `0.05`）

-   `--TotalCompressionThreshold <パーセント>` (エイリアス: `-tcr`)
    **変換後の画像セットを採用する判断基準となる圧縮率（%）**を指定します。`0`から`100`の間の小数が指定できます。

-   `--SkipCompression` (エイリアス: `-sc`)
    このスイッチを指定すると、リサイズ、品質再設定、傾き補正、余白除去、コントラスト調整など、**ファイルの内容を変更する可能性のある最適化処理をすべてスキップ**し、元画像の品質を最大限維持します。

### 余白除去の設定

-   `--Trim`
    このスイッチを指定すると、画像変換処理の前に、ImageMagickの`-trim`機能を使って画像の周囲にある余白（単一色の背景）を自動的に除去します。

-   `--Fuzz <文字列>`
    `--Trim`機能が「同じ色」と見なす色の許容範囲を指定します。デフォルトは `1%` です。

### 傾き自動補正

-   `--Deskew` (エイリアス: `-ds`)
    このスイッチを指定すると、ImageMagickの`-deskew`機能を使って、画像の傾きを自動的に検出して補正します。

### コントラスト・紙焼け調整

-   `--AutoContrast` (エイリアス: `-ac`)
    **カラーページ**のコントラストを自動で最適化します。ImageMagickの`-normalize`機能を使用し、画像の明るさの範囲を最大化します。

-   `--GrayscaleLevel <文字列>` (エイリアス: `-gl`)
    **グレースケール（白黒）ページ**に適用されるコントラスト調整です。ImageMagickの`-level`機能を使い、紙焼け（背景の黄ばみ）除去に効果的です。

-   `--ColorContrast <文字列>` (エイリアス: `-cc`)
    **カラーページ**に適用されるコントラストを手動で調整します。ImageMagickの`-brightness-contrast`機能を使います。

### PDF出力設定

-   `--SetPageSize`
    このスイッチを指定すると、`--PaperSize`で設定された用紙サイズ（例: A4, B5）が、PDFのページの物理的なサイズとして明示的に設定されます。
    -   **デフォルトの動作（推奨）**: このスイッチを指定しない場合、`pdfcpu`が画像サイズに合わせてページサイズを自動決定します。この方法では、縦長・横長の画像が自動的に正しく処理されるため、最も安定して動作します。
    -   **コマンドラインでの注意**: `--PaperSize`を指定すると、このオプションは自動的に有効になります。無効にしたい場合は、`--SetPageSize=False`のように明示的に指定する必要があります。（Pythonの`argparse`の仕様）

-   `--Landscape`
    `--SetPageSize`スイッチと同時に使用した場合に、ページを横向き（Landscape）に設定します。

### PDFのウェブ最適化設定

-   `--Linearize` (エイリアス: `-lin`)
    このスイッチを指定すると、生成されたPDFを「リニアライズ（Fast Web View、Web表示用に最適化）」します。

### ログと出力の設定

-   `--LogPath <パス>`
    ログファイルの出力先を指定します。

## 使用方法

### 対話モードでの実行（簡単・推奨）
スクリプトをオプション引数なしで実行すると、対話モードが始まります。

```bash
python3 JisuiArc2PDF.py "MyBook.zip"
# または
python3 JisuiArc2PDF.py
```

**対話モードの流れ**
1.  実行すると、まず変換設定に関する質問が順番に表示されます。
2.  角括弧 `[ ]` 内に表示されているのはデフォルト値です。その設定でよければ、何も入力せずに `Enter` キーを押してください。
3.  値を変更したい場合は、希望の値を入力して `Enter` キーを押します。
4.  すべての設定が完了すると、処理が開始されます。

### コマンドラインでの実行（詳細設定）
全てのオプションを自分で指定して実行したい場合は、引数をコマンドラインから渡します。

```bash
# 品質を90、高さを2000pxに指定して、全ての.rarファイルを処理
python3 JisuiArc2PDF.py *.rar --Quality 90 --Height 2000

### 総合的な使用例

複数のオプションを組み合わせて、より細かく変換プロセスを制御することができます。

#### 使用例1: 高画質・高圧縮、全自動補正（推奨設定）
画質を維持しつつ、可能な限りの補正と圧縮をバランス良く行う、最も標準的で推奨される設定です。

```bash
python3 JisuiArc2PDF.py "C:\Scans\*.zip" -p B5 -d 300 -q 92 --GrayscaleLevel "10%,90%" --AutoContrast --Deskew --TotalCompressionThreshold 95 -v
```

このコマンドは、以下の処理を実行します。
-   **対象**: `C:\Scans\` フォルダ内にある、すべての `.zip` ファイル。
-   **解像度**: `-p B5 -d 300` → B5用紙サイズ、300 DPIに設定してリサイズします。
-   **画質**: `-q 92` → JPEG品質を `92` に設定します。デフォルト(85)より高画質になります。
-   **コントラスト**: `--GrayscaleLevel "10%,90%" --AutoContrast` → 白黒ページは紙焼けを補正し、カラーページはコントラストを自動調整します。
-   **補正**: `--Deskew` で傾きを自動補正します。
-   **圧縮制御**: `--TotalCompressionThreshold 95` → 変換後の合計サイズが元の95%未満にならなかった場合は、画質維持を優先します。
-   **詳細表示**: `-v` → コンソールに詳細な処理状況を出力させます。

---

#### 使用例2: 品質最優先（画集・雑誌向け）
解像度とJPEG品質を高く設定し、ファイルサイズよりも画質を最優先します。カラーイラストや写真が多い書籍に適しています。

```bash
python3 JisuiArc2PDF.py "C:\Artbooks\*.rar" -h 2400 -q 98 --AutoContrast --Deskew --TotalCompressionThreshold 99
```
-   **解像度**: `-h 2400` → 高さを2400pxに固定します。
-   **画質**: `-q 98` → JPEG品質を `98` に設定し、圧縮ノイズを最小限に抑えます。
-   **コントラスト**: `--AutoContrast` → カラーページのコントラストを自動で最適化します。
-   **傾き補正**: `--Deskew` → 傾きを補正します。
-   **圧縮制御**: `--TotalCompressionThreshold 99` → ファイルサイズがほとんど減らない場合でも、リサイズと補正の結果を適用します。

---

#### 使用例3: 漫画・コミック向け（サイズと品質のバランス）
漫画の単行本（B6サイズなど）に多い設定です。解像度を少し抑え、紙焼け補正を少し強めに設定することで、読みやすさとファイルサイズのバランスを取ります。

```bash
python3 JisuiArc2PDF.py "D:\Manga\*.zip" -p B6 -d 200 -q 88 --GrayscaleLevel "15%,85%" --AutoContrast --Deskew
```
-   **解像度**: `-p B6 -d 200` → B6サイズ、200 DPIに設定。一般的なディスプレイで読むには十分な解像度です。
-   **画質**: `-q 88` → 標準的な品質設定です。
-   **コントラスト**: `--GrayscaleLevel "15%,85%" --AutoContrast` → 白黒ページの紙焼け補正を少し強めにかけ、古い漫画の黄ばみを目立たなくします。カラーページは自動調整します。
-   **傾き補正**: `--Deskew` → 傾きを補正します。

## バッチファイルによる簡単な起動 (Windows)
```

**Windowsユーザー向け**の機能です。コマンドラインに慣れていない方向けに、`JisuiArc2PDF_py.bat` を同梱しています。

-   **使い方**: 処理したい書庫ファイル（`.zip`, `.rar`など）を、`JisuiArc2PDF_py.bat` のアイコン上にドラッグ＆ドロップします。黒い画面が起動し、すぐに対話モードが始まります。
-   **直接実行**: バッチファイルをダブルクリックで直接実行した場合は、最初に対象ファイルのパスを入力するよう求められます。

## ライセンス

このプロジェクトは [The Unlicense](LICENSE) のもとで公開されており、パブリックドメインに属します。

---

## おまけ: PDFを画像書庫に戻す (JisuiPDF2Arc.py)

このリポジトリには、逆変換を行う `JisuiPDF2Arc.py` も同梱されています。このスクリプトは、PDFファイルから全ての画像を抽出し、ZIP書庫として保存します。
